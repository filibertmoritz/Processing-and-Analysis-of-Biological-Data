---
title: "Exercise 11: Practice Exam"
author: 'Fausto, Pauline Mergel and Filibert Heim'
format: pdf
date: "`r Sys.Date()`"
fig_caption: yes
pandoc_args: ["--wrap=none"]
---

```{r, message=F, include=F}
# some preparations 
library(tidyverse)
library(lme4)
select <- dplyr::select
rename <- dplyr::rename 
filter <- dplyr::filter

data <- read.csv('C:/Users/filib/Documents/Studium/Master/Processing and Analysis of Biological Data/data/exam2023_data-2.csv')

# data manipulation
data <- data %>% drop_na() %>% 
  mutate(eucalyptus = euc_sdlgs0_50cm + euc_sdlgs50cm.2m +euc_sdlgs.2m, # calc number of eucalyptus across all age classes
         grass_cover = ExoticAnnualGrass_cover + NativePerennialGrass_cover + NativePerennialGraminoid_cover) %>% # calc grass cover independently of exact type
  select(eucalyptus, Season, Property, Easting, Northing, SRad_Jan, annual_precipitation, precipitation_warmest_quarter, Distance_to_Eucalypt_canopy.m., BareGround_cover, grass_cover, Euc_canopy_cover) 

# scale all numeric predictor variables and store with a scaled prefix (ChatGPT help)
data <- data %>% 
  mutate(across(where(is.numeric), ~ as.numeric(scale(.x)), .names = "{.col}_scaled"))


# built formulas for first step light and nullmodel
formulas <- list(nullmodel = formula(eucalyptus ~ (1|Property) + (1|Season)), 
                 SRad_Jan = formula(eucalyptus ~ SRad_Jan_scaled + (1|Property) + (1|Season)), 
                 `SRad_Jan + Euc_canopy_cover` = formula(eucalyptus ~  SRad_Jan_scaled + Euc_canopy_cover_scaled +  (1|Property) + (1|Season)))

# fit models for first step light 
models <- list()
for(f in names(formulas)){
  models[[f]] <- glmer(formula = formulas[[f]], family = poisson(link = 'log'), 
                       data = data) 
}

# compare models using AIC
aictable <- AICcmodavg::aictab(models) 

# make formulas for second step for water continuing with the single best model
formulas <- c(formulas, list(`SRad_Jan + Euc_canopy_cover + annual_precipitation` = formula(eucalyptus ~ SRad_Jan_scaled + Euc_canopy_cover_scaled + annual_precipitation_scaled + (1|Property) + (1|Season)), 
                             `SRad_Jan + Euc_canopy_cover + annual_precipitation + precipitation_warmest_quarter` = formula(eucalyptus ~ SRad_Jan_scaled + Euc_canopy_cover_scaled + annual_precipitation_scaled + precipitation_warmest_quarter_scaled + (1|Property) + (1|Season))))

# fit models for second step for water
for(f in names(formulas)){
  models[[f]] <- glmer(formula = formulas[[f]], family = poisson(link = 'log'), 
                       data = data) 
}

# get best model using AIC
aictable <- AICcmodavg::aictab(models) 

# create formulas for second step for establishment
formulas <- c(formulas, list(`SRad_Jan + Euc_canopy_cover + Distance_to_Eucalypt_canopy.m.` = formula(eucalyptus ~ SRad_Jan_scaled + Euc_canopy_cover_scaled + Distance_to_Eucalypt_canopy.m._scaled + (1|Property) + (1|Season)),
                             `SRad_Jan + Euc_canopy_cover + Distance_to_Eucalypt_canopy.m. + BareGround_cover` = formula(eucalyptus ~ SRad_Jan_scaled + Euc_canopy_cover_scaled + Distance_to_Eucalypt_canopy.m._scaled + BareGround_cover_scaled + (1|Property) + (1|Season)), 
                             `SRad_Jan + Euc_canopy_cover + Distance_to_Eucalypt_canopy.m. + BareGround_cover + grass_cover` = formula(eucalyptus ~ SRad_Jan_scaled + Euc_canopy_cover_scaled + Distance_to_Eucalypt_canopy.m._scaled + BareGround_cover_scaled + grass_cover_scaled + (1|Property) + (1|Season))))

# fit models for third step for possibilities of establishment
for(f in names(formulas)){
  models[[f]] <- glmer(formula = formulas[[f]], family = poisson(link = 'log'), 
                       data = data) 
}

# get best model using AIC
aictable <- AICcmodavg::aictab(models) 

# extract best model
best_model <- models[[aictable[1,1]]]

# model summary 
summary(best_model)

```

# Exercise 1

aw (on paper) the path diagram corresponding to this model, and add the estimated path coefficients, including the (Pearson) correlations (function cor in R) between the exogeneous (predictor) variables. We can calculate the unexplained variance (“U”) in the response as √(1 − r2) (which places it on the standardized [correlation] scale like the path coefficients). Interpret the results.

In this model we can calculate the total (net) effect of snow cover on the abundance of Carex bigelowii by summing the direct effect and the effects arising through correlations with other variables

```{r}
summary(m1) # for getting the coefficients 
cor(plants$soil_moist, plants$min_T_winter, "pairwise") # to get the pairwise correlations
cor(plants$snow, plants$soil_moist, "pairwise")
cor(plants$min_T_winter, plants$soil_moist, "pairwise")

sqrt(1-summary(m1)$r.squared) # get unexplained variance on the standardised correlation scale

```

In the second model, there is (as expected) a strong positive effect of snow cover on minimum winter soil temperature, and in turn a positive effect of winter soil temperature on Carex bigelowii. Thus, under this model, we have strong support for the hypothesized causal links from snow cover to Carex abundance.

# Exercise 2

Draw the path diagram and interpret the direct and indirect effects of snow cover on Carex abundance.

```{r}
summary(m2a) 
summary(m2b) 
summary(m2c)


```

# Structural equation modelling

Structural equation modelling is a further development that offers greater flexibility compared to traditional path analysis. Traditional structural equation models are estimated globally (in one go) based on a covariance matrix including all the candidate variables. An alternative approach is to build the SEM piecewise as a series of models fitted independently (“local estimation”) and then combined. Below we fit our second candidate model using the second approach and the piecewiseSEM package. 

```{r, message=F}
library('piecewiseSEM')

# fit SEM
m2 <- psem(lm(soil_moist~snow, data=plants),
          lm(min_T_winter~snow, data=plants),
          lm(Carex.bigelowii~min_T_winter+soil_moist, data=plants),
          data=plants)

summary(m2)
```

Beyond simply fitting the component models, the piecewiseSEM package implements tests of so-called directed separation (“d-separation”), which is a test for conditional independence of variables. Here, the key test is if Carex abundance is really conditionally independent of snow cover, i.e. after we have accounted for winter soil temperature and growing-season soil moisture. The interpretation of these tests is different from what we are used to for normal models. In this case the null hypothesis is that our model represents the data well, and that adding an additional link (such as the one from snow cover directly to Carex abundance) would not improve the model sufficiently to be favoured. Therefore, statistical support (a low p-value or support in AIC comparison) therefore indicates bad model fit, while lack of statistical support (e.g. a higher p-value) indicate decent fit to the data. However, as always, we need to interpret any result in light of the parameter estimates.

Note that for a SEM containing multiple of these “independence claims”, the piecewiseSEM package also provides a hypothesis test for the entire model, again with a high p-value indicating a decent fit to the data. This test is based on comparing the likelihood of the current model to a saturated model including the missing paths. The output of the current model includes a test of directed separation for the relationship between winter temperature and soil moisture, which was not our main interest in this case, and we would like to treat this as an untested correlation (corresponding to double-headed arrows in our traditional path analysis above). We can achieve this through the somewhat exotic %~~% operator within the psem function.

```{r}
m2b = psem(lm(soil_moist~snow, data=plants),
           lm(min_T_winter~snow, data=plants),
           lm(Carex.bigelowii~min_T_winter+soil_moist, data=plants),
           min_T_winter %~~% soil_moist,
           data=plants)
summary(m2b)
```

# AIC model selection for structural equation models

The AIC values reported by the model summary is the total AIC of the model, obtained by summing the AIC values of the component models (log likelihoods and thus AIC values are additive). We can use this to compare our chosen model to a null model (with nothing affecting nothing), or an alternative model with different sets of paths. As an example, we formulate a third alternative model with different paths missing and compare it to our model 2 using AIC. Specifically, we omit the arrow from soil moisture to Carex abundance.

```{r}
m3 = psem(lm(soil_moist~snow, data=plants), 
          lm(min_T_winter~snow, data=plants), 
          lm(Carex.bigelowii~min_T_winter, data=plants),
          min_T_winter %~~% soil_moist,
          data=plants)
summary(m3)
```

After fitting the two hypothesis, the models can be compared using AIC. 

```{r}
AIC(m2b, m3)
```

The third model seems to be the best. 

One nice feature of the piecewiceSEM package is that is allows the component models to be for example GLM’s or mixed models. This offers greater flexibility for including non-Gaussian variables, and for modelling structure in the data (e.g. non-independence of data points).

# Exercise 3:

Repeat the analyses above for Thalictrum alpinum instead of Carex.

# Exercise 4:

Can you think of other potential models that can be tested? Are there other important environ- mental variables? Start by drawing the competing models as directed graphs (on paper). Fit and compare the models, and interpret the results.